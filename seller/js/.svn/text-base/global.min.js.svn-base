/**
 * 页面事件处理程序绑定
 * @return {[type]} [description]
 */
function pageHandle(){    
    var startX = 0, startY = 0, isMove = false;    
    $(document)
        .on("touchstart", "[tap-handler]", function(e){
            isMove = false; 
            var oMove = fnGetTouchPosition(e);
            startX = oMove.x;
            startY = oMove.y;    
        })
        .on("touchmove", "[tap-handler]", function(e){
            // console.log("move");
            // isMove = true;
            var oMove = fnGetTouchPosition(e),
                nDistance = 10
            ;
            // alert(Math.abs(oMove.x - startX));
            if(Math.abs(oMove.x - startX) > nDistance || Math.abs(oMove.y - startY) > nDistance){
                isMove = true;
            }
            // console.log(2343243);
        })
        .on("touchend", "[tap-handler]", function(e){
            if(!isMove){
                var fnHandle = $(this).attr("tap-handler");
                eval(fnHandle);
            }
        })
    ;
}

/*
 * 获取移动坐标信息
 */
function fnGetTouchPosition(e) {
    var touches = e.changedTouches || e.originalEvent.changedTouches,
        oMove = {
            x: e.pageX,
            y: e.pageY
        }
    ;
    if(e.type.indexOf("touch") > -1){
        oMove.x = touches[touches.length - 1].pageX;
        oMove.y = touches[touches.length - 1].pageY;
    }

    return oMove;
}

if(window.define){//加个判断兼容
    define(["jquery", 
        "angular", "util", 
        "say", "loading", "confirm", "underscore", "services/userService"
        ],function($, angular, Util, Say, Loading, Confirm, _){
        // pageHandle();//绑定页面处理程序

        var global = angular.module('global', [], ["$httpProvider", function($httpProvider){
            $httpProvider.defaults.headers.common["content-type"] = 'application/json; charset=UTF-8';
        }]);

        //根controller
        global.controller('GController', ["$rootScope", "$scope", "$timeout", "$filter", "userService",
        function($rootScope, $scope, $timeout, $filter, userService){
            $scope.Util = Util;
            $rootScope.logout = userService.logout;

            //获取购物车数量
            $rootScope.userInfo = {};
            $rootScope.getUserInfo = function(){
                userService.getLoginUser().then(function(data){
                    $rootScope.userInfo = data || {};
                    // $rootScope.getCartCount();
                });
            };

            // //获取购物车数
            // $rootScope.getCartCount = function(){
            //     cartService.getCartCount().then(function(data){
            //         $rootScope.userInfo.cart_count = data.datas;
            //     });
            // };


            //利用黑科技设置微信title
            var isWeChat = navigator.userAgent.toLowerCase().indexOf("micromessenger") > -1;    //是否微信浏览器
            if(isWeChat){
                var watcher = $scope.$watch("pageTitle", function(newData, oldData){
                    $timeout(function() {
                        var jTitleIframe = $(".ifTitle");
                        if(!jTitleIframe.length){
                            jTitleIframe = $('<iframe class="ifTitle"></iframe>')
                                .hide()
                                .attr("src", "./favicon.ico")
                                .appendTo($('body'))
                            ;
                        }

                        jTitleIframe.on('load', function() {
                            $timeout(function() {
                                jTitleIframe.off("load").remove();
                            }, 0);
                        });
                    }, 100);
                }, true);
            }

            // $scope.logout = userService.logout;

            /**
             * 页面加载相关控制事件句柄
             */
            $scope.$on("$viewContentLoaded", function(){
                $timeout(function(){
                    document.body.scrollTop = 0;
                }, 0);
                
                if(window.isJqueryInit){
                    return;
                }
                window.isJqueryInit = true;

                $(document).on("touchstart", ".stress-item", function(){});
            });

            $scope.$on('$stateChangeStart', function(){
                $('.ks-ext-mask,.base-overlay').remove();
            })
        }]);

        global.filter('trustHtml', ["$sce", function($sce){
            return function (text){
                return $sce.trustAsHtml(text);
            }
        }]);

        return global;
    });
} else{
    pageHandle();//绑定页面处理程序
}

/*
 * requestAnimationFrame
*/
(function() {
    var lastTime = 0;
    var vendors = ['webkit', 'moz'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||    // name has changed in Webkit
                                      window[vendors[x] + 'CancelRequestAnimationFrame'];
    }

    if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
            var id = window.setTimeout(function() {
                callback(currTime + timeToCall);
            }, timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
    }
    if (!window.cancelAnimationFrame) {
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
    }
}());

/**
 * 屏幕尺寸适配
 */ 
function fnResize(){
    var nWinWidth = window.innerWidth,
        nWinHeight = window.innerHeight,

        STANDARD_WIDTH = 375,
        STANDARD_HEIGHT = document.getElementsByTagName("html")[0].getAttribute("contentMinH") || 667 - 64//667 - 64//去掉头部默认的64像素
    ;
    // STANDARD_HEIGHT = 667 - 64;
    // if(nWinWidth > 540){
    //     nWinWidth = 540;
    // }

    if(nWinWidth/nWinHeight > STANDARD_WIDTH / STANDARD_HEIGHT){//胖子，按高度适配
        document.getElementsByTagName("html")[0].style["fontSize"] = ((nWinHeight / STANDARD_HEIGHT) * 16) + "px";
    } else{//瘦子，按宽度适配
        document.getElementsByTagName("html")[0].style["fontSize"] = ((nWinWidth / STANDARD_WIDTH) * 16) + "px";
    }
    // document.getElementsByTagName("html")[0].style["fontSize"] = ((nWinWidth / STANDARD_WIDTH) * 16) + "px";
}