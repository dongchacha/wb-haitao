/**
 * 懒加载
 *
 * @author dongxiaochai@163.com
 * @since 2016-02-23
 */
"use strict";
define([], function(){
    var DEFAULT_CONFIG = {
            lazyFn: null,       //懒加载函数
            // effect: "fadeIn",   //载入动画效果
            threshold: 0      //提前多少像素加载
        },        
        sLazyloadFnAttr = "data-lazyload-fn",
        sLazyloadSrcAttr = "data-lazyload-src"
    ;

    /**
     * 
     * @param {Object} oConfig
     */
    function lazyload(oConfig) {
        oConfig = $.extend({}, DEFAULT_CONFIG, oConfig || {});
        var _thisLazyList = this;

        /**
         * 屏幕滚动懒加载处理
         * @return {void}
         */
        function scrollHandler(){
            $(_thisLazyList).each(function(){
                if(getIsInView(this)){//
                    var jThis = $(this);

                    //懒执行函数
                    oConfig.lazyFn && oConfig.lazyFn();
                    if(jThis.is("["+ sLazyloadFnAttr +"]")){
                        try{
                            eval(jThis.attr(sLazyloadFnAttr));
                        } catch(ex){}

                        jThis.removeAttr(sLazyloadFnAttr);
                    }

                    //懒加载图片
                    if(jThis.is("["+ sLazyloadSrcAttr +"]")){
                        var img = new Image(),
                            sSrc = jThis.attr(sLazyloadSrcAttr)
                        ;

                        img.src = sSrc;

                        if(img.complete) {// 如果图片已经存在于浏览器缓存，直接调用回调函数
                            fnCallback();
                            return; // 直接返回，不用再处理onload事件
                        }

                        img.onload = function(){
                            fnCallback();
                        }

                        function fnCallback(){
                            img.onload = null;
                            img = null;

                            jThis
                                .hide()
                                .prop("src", sSrc)
                                .removeAttr(sLazyloadSrcAttr).fadeIn()
                            ;
                        }
                    }
                    _thisLazyList = _thisLazyList.not(jThis);
                }
            });

            if(_thisLazyList.length === 0){
                $(window).off('scroll resize', scrollHandler);
            }
        };

        $(window).on('scroll resize', scrollHandler);
        scrollHandler();//默认执行一次

        /**
         * 判断对象是否在可视窗口内
         * @param  {Object} target 判断对象
         * @return {Boolean}
         */
        function getIsInView(target){
            var nWinTop = $(window).height() + $(window).scrollTop();

            return $(target).offset().top <= nWinTop + oConfig.threshold;
        }
    }

    $.fn.extend({
        lazyload: lazyload
    });
});